<!doctype html>
<html>
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Latin Audio Flashcards — Static</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f8fafc;padding:24px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.06);max-width:900px;margin:auto}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input,select{padding:8px;border-radius:8px;border:1px solid #e6eef8}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:#4f46e5;color:#fff;cursor:pointer}
    .small{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Latin Audio Flashcards (Static)</h1>
    <p class="small">Upload CSV, pick voice and play. No MP3 export in this static version.</p>
    <div class="controls">
      <input id="csv" type="file" accept=".csv" />
      <label class="small">Front language</label>
      <select id="frontLang">
        <option value="en">English (en)</option>
        <option value="la">Latin (la)</option>
        <option value="el">Ancient Greek (el)</option>
        <option value="it">Italian (it)</option>
        <option value="fr">French (fr)</option>
        <option value="de">German (de)</option>
        <option value="es">Spanish (es)</option>
      </select>
      <select id="frontVoice" style="min-width:200px"></select>

      <label class="small">Back language</label>
      <select id="backLang">
        <option value="la">Latin (la)</option>
        <option value="en">English (en)</option>
        <option value="el">Ancient Greek (el)</option>
        <option value="it">Italian (it)</option>
        <option value="fr">French (fr)</option>
        <option value="de">German (de)</option>
        <option value="es">Spanish (es)</option>
      </select>
      <select id="backVoice" style="min-width:200px"></select>

      <button id="load" class="btn">Load & Play</button>
      <button id="exportMp3" class="btn">Export MP3</button>
      <button id="stop" class="btn" style="background:#ef4444">Stop</button>
    </div>
    <div id="log" style="margin-top:12px" class="small"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const csv = document.getElementById('csv');
    const frontLang = document.getElementById('frontLang');
    const backLang = document.getElementById('backLang');
    const frontVoice = document.getElementById('frontVoice');
    const backVoice = document.getElementById('backVoice');
    const log=document.getElementById('log');

    let _voices = [];
    function buildVoiceText(v){ return v.name + ' — ' + v.lang + (v.default ? ' (default)' : ''); }

    function mapLangForMatching(code){ const map = { la: 'it' }; return map[code] || code; }

    function populateVoiceSelect(sel, code){ sel.innerHTML=''; const c = mapLangForMatching(code).toLowerCase(); _voices.forEach((vo,i)=>{ if(vo.lang && vo.lang.toLowerCase().startsWith(c)){ const o=document.createElement('option'); o.value = i; o.textContent = buildVoiceText(vo); sel.appendChild(o); } }); if(sel.options.length===0){ const o=document.createElement('option'); o.value='-1'; o.textContent='No matching voices'; sel.appendChild(o); } }

    function loadVoices(){ _voices = speechSynthesis.getVoices()||[]; populateVoiceSelect(frontVoice, frontLang.value); populateVoiceSelect(backVoice, backLang.value); }
    speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

    frontLang.onchange = ()=> populateVoiceSelect(frontVoice, frontLang.value);
    backLang.onchange = ()=> populateVoiceSelect(backVoice, backLang.value);

    function speak(text, voiceIdx){ return new Promise(r=>{ if(!text) return r(); const u=new SpeechSynthesisUtterance(text); const v=speechSynthesis.getVoices()[voiceIdx]; if(v) u.voice=v; u.onend=()=>setTimeout(r,80); speechSynthesis.speak(u); }) }

    async function playRows(rows){ const max = Math.min(rows.length, 1000); for(let idx=0; idx<max; idx++){ const row = rows[idx]; const frontText = row.English || row.english || row.Front || row.front || row[Object.keys(row)[0]] || ''; const backText = row.Latin || row.latin || row.Back || row.back || row[Object.keys(row)[1]] || ''; const fIdx = parseInt(frontVoice.value,10); const bIdx = parseInt(backVoice.value,10); if(!isNaN(fIdx) && fIdx>=0) await speak(frontText, fIdx); await new Promise(s=>setTimeout(s,300)); if(!isNaN(bIdx) && bIdx>=0) await speak(backText, bIdx); await new Promise(s=>setTimeout(s,700)); } }

    document.getElementById('load').onclick = ()=>{
      if(!csv.files.length){ alert('Pick CSV'); return; }
      Papa.parse(csv.files[0],{header:true,skipEmptyLines:true,complete:(res)=>{ const rows=res.data; log.textContent = 'Loaded '+rows.length+' rows — playing first 20.'; playRows(rows.slice(0,20)); }})
    };

    document.getElementById('stop').onclick = ()=>speechSynthesis.cancel();

    // Export to backend MP3
    document.getElementById('exportMp3').onclick = async ()=>{
      if(!csv.files.length){ alert('Pick CSV'); return; }
      const endpoint = (window.BACKEND_SYNTH_URL || 'http://localhost:5000/synthesize');
      const fd = new FormData(); fd.append('file', csv.files[0]); fd.append('language_for_front', frontLang.value); fd.append('language_for_back', backLang.value);
      log.textContent = 'Uploading and requesting MP3 — this may take a while...';
      try{
        const resp = await fetch(endpoint, { method: 'POST', body: fd });
        if(!resp.ok){ const txt = await resp.text(); throw new Error('Server error: '+txt); }
        const blob = await resp.blob();
        const disp = resp.headers.get('Content-Disposition') || '';
        const fileNameMatch = /filename\*=UTF-8''([^;]+)|filename="?([^\";]+)"?/.exec(disp);
        let fname = 'exported_audio.mp3';
        if(fileNameMatch){ fname = decodeURIComponent(fileNameMatch[1] || fileNameMatch[2]); }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        log.textContent = 'Download started: '+fname;
      }catch(e){ console.error(e); alert('Export failed: '+e.message); log.textContent = 'Export failed: '+e.message; }
    };

  </script>
</body>
</html>
